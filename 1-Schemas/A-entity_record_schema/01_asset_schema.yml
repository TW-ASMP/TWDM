$schema: 'http://json-schema.org/draft-07/schema'
title: asset
$id: https://raw.githubusercontent.com/TW-ASMP/TWmaximoConfig/main/1-Schemas/A-entity_record_schema/01_asset_schema.yml
type: object

properties:
  asset ID:
    type: string
    description: 
      A read-only UUID, generated by the system, to uniquely identify the asset record.
    sort order: 1-10
    TW_rule:
      #....
      - name: Vertical Asset ID
        id: 41JeoQuvex 
        type: [assertion]
        specification: |
          Upon the creation of a new vertical facility asset record generate a unique asset ID (such as UUID Ver4)
        checked on: 2024-08-15
        $comment: |
          UUID has a distinct advantage over a simple serial number - we do not need a script to check for repetition. For instance, when onboarding assets from another system or a spreadsheet, we don't need to check the WMS to see if the ID was already taken.
      #....
      - name: Linear Asset ID
        id: Vku-67dDxx
        type: [assertion]
        specification: |
          Upon the creation of a new asset record corresponding to a record in TWAG, through the Maximo-TWAG integration, 
            populate the TWAG asset record's "Facility ID" value into the "asset ID".
        checked on: 2024-08-15
        $comment: see comment for rule 41JeoQuvex.

  #========================

  asset name:
    type: string 
    description: The human readable short description of the asset.
    sort order: 1-20
    TW_rule:
      - name: Asset Naming
        id: 4ykh0m_Dle
        type: assertion
        specification: | 
          if asset_x.properties."is a commercially available product" = TRUE 
            asset_x.properties."asset name" is the semi-colon delimited concatenation of:
              - properties."asset class".properties."class name"
              - properties."product item master record".properties."product manufacturer company" 
              - properties."product item master record".properties."product model (and sub-model) description"
              - properties."product item master record".properties."product configuration code"
              - properties."OEM serial"
          elif asset_x.properties."is a commercially available product" = FALSE
            asset_x.properties."asset name" is the semi-colon delimited concatenation of:
              - properties."asset class".properties."class name"
              - properties."assigned to role".properties."role name"
          # NOTE: actual script should contain additional condition handle formatting of the name text when there is missing data in any concatenated property.
        status: [specified, checked] 
    $comment: |
        Assumption: an non-is a commercially available product is always built on site for a specific purpose, and would permenantly occupy a role. An example is an aeration tank. 
  
  #========================

  TWAG asset:
    type: boolean
    description: A true value indicates that this record represent an asset that is also represented by a record in TWAG. 
    sort order: 1-50

  #========================

  asset class:
    $ref: /1-Schemas/B-entity_class_object_schema/01_asset_class_object_schema.yml
    description: Indicates the primitive asset class to which this asset is an instance.
    sort order: 1-30
    type: assertion
    TW_rule:
      #....
      - name: exclusion of parts ("never a stand-alone asset") from asset classification 
        id: V15NNHZuxl
        type: [validation, UI]
        specification: |
          Assertion Part:
            For all assets "asset_x",
              the value of (asset_x."asset class".properties."never a stand-alone asset") must be FALSE
          UI Part:
            In all asset classification search or selection screens, eliminate or filter out all classses "class_y",
              where (class_y.properties."never a stand-alone asset") is TRUE
        checked on: 2024-08-15

  #-----------------

  inferred class name(s):
    oneOf: 
      - type: array
        items:
          type: string
      - type: NULL
    updated by system: TRUE
    sort order: 1-40
    description: Indicates the complex classes to which this asset is an instance. A complex class is defined with reference to a primitive class plus other attributes. An example of a complex class is the TSSA high-pressure boiler class, which is made with reference to th primitive class boiler. 
    $comment: |
      This field will be populated by a rule processor, likely operation outside of Maximo and with integration to Maximo. An example of the inferred class is "high-pressure boiler".  The values are strings instead of classification objects because the inferred classes will not be in Maximo's asset classification.
  
  
  # State and Status Group of Properties
  #========================

  physical status:
    type: string
    description: Indicates whether the asset is present at the City, and more precisely, at its working location. It also indicates when the knowledge of the asset's presence is missing (i.e., it is missing or lost).
    enum:
      - planned
      - in possession
      - installed
      - abandoned in place
      - removed from possession
      - missing 
      - lost
    $comment: |
      This data field is not NULLable becauase the lack of knowledge is explicitly expressed as "missing" or "lost", and the non-existence is expressed as "planned" or "removed from possession".

  #-----------------

  operating state:
    type: string
    description: Indicates whether the asset is available for doing the work that it is assigned at a given moment. Only applies to asset that is assigned to a role, user-group, or user.
    enum:
      - available (up) 
      - unavailable (down)  
      - not applicable
    $comment: |
      The "not applicable" value is being represented explicitly in the value list, because when we are reporting on equipment uptime, we need to know about the periods in which the operating state is not applicable. For example, if the asset is not assigned to any role, organization, or anyone.

  
  # Ownership Property Group
  #========================

  owned by the organization:
    oneOf: 
      - $ref: A-entity_record_schema/04_org_schema.yml
      - type: NULL
    description: Denotes the organization that owns the asset.
    sort order: 1-70
    TW_rule: 
      - name: Valid Data Values for "owned by the organization" Property
        id: 410N2dr_xx
        type: [validation,UI]
        specification: |
          - The valid range of values for selection includes the first, second, and third levels of the organizational hierarchy, specified in the (\TWmaximoConfig\3-System_Hierarchies\04_org_hierarchy.md) . For examples,
            - first level example: York Region, 
            - second level example: Toronto Water
            - third level example: Water Treatment & Supply Section 
          - The UI must only present the valid range of values to the users for selection, and the valid range of values must be presented as a hierarchy.
        status: [specified]
  
  #------------

  owned by private citizen or other organization:
    oneOf:
      - type: boolean
      - type: NULL
    TW_rule:
      #....
      - name: Consistency Between the "owned by the organization" and "owned by other private citizen or organization" Property Values
        id: VJzY4p45ge
        type: [assertion, validation]
        specification: |
          if the value of (.properties."owned by the organization") is NOT NULL
            then the value of (.properties."owned by other private citizen or organization") property must be FALSE
          if the value of (.properties."owned by other private citizen or organization") is TRUE
            then the value of (.properties."owned by the organization") property must be NULL         
        status: [specified, checked]
  
  # Item and Tool Property Group
  #========================

  is a commercially available product:
    type: boolean
    description: An asset is made under as a product of a commercial entity, as opposed to an asset that is assembled on site.
    sort order: 1-80
    $comment: No NULL value allowed becuase this information is self-evident
    TW_rule:
      #....
      - name: Automatic Value Assignment to properties."is a commercially available product"
        id: 4Jg2gYSOee
        type: [assertion]
        specification: |
          - Upon record creation, set the value to TRUE.
          - Upon a .properties."asset class" value change or a re-run of the Maximo rule processor,  
              if .properties."asset class".properties."non-manufactured" = TRUE;
                set the value to TRUE;
              else set the value to FALSE.  
        status: [specified]
  
  #------------
  
  is a tool:
    type: boolean
    description: A "true" value would designate the asset as a rotating tool, which allows the asset to be 1. reserved for work or 2. assgined to a staff or group (which includes fixed tools). "Rotating" is a Maximo term for a tool (or item) that is also represented as a serialized asset. This allows maintenance work to be specified and the current location and condition of the tool to be tracked.
    sort order: 1-90
    $comment: Note that this property was changed from "mobile tool" because this designation also applies to fixed tools, such as machine shop or lab tools. All of these assets fall within the definition of a tool, which is something that enables or enhances the ability of a human agent to perform a piece of maintenance, repair, testing, and investigative work.
    TW_rule:
      #....   
      - name: Automatic assignment to the value of (.properties."is a tool")
        id: 41sz7KSdxe
        type: assertion
        specification: |
          - Upon record creation, set the default value to FALSE.          
          - Upon a .properties."asset class" value change or a re-run of the Maximo rule processor,  
              if .properties."asset class".properties."tool" = TRUE;
                then set the value to TRUE;        
        status: [specified, checked]
  
  #------------

  product item master record:
    oneOf: 
      - $ref: A-entity_record_schema/05_item_master_schema.yml
      - type: NULL
    description: This field links the asset to an item record that defines a commercially available product. By effect, it also deems to asset to be a rotating item. 
    TW_rule:
      #....
      - name: If an asset is commercially available but not a tool, then it needs a item master record
        id: VJY43yI9lx
        type: [assertion, UI]
        specification: |
          if (asset_x.properties."is a commercially available product" = TRUE) AND (asset_x.properties."is a tool" = FALSE), then
            - (asset_x.properties."product item master record") is NOT NULL
            - enable (asset_x.properties."product item master record") in UI
          else
            - (asset_x.properties."product item master record") is NULL
            - disable (asset_x.properties."product item master record") in UI
        status: [specified, checked]
      #....
      - name: a commmercially available asset must be associated with product information (part of an item record)
        id: 4y3dRfLcee
        type: validation
        specification: |
          if (asset_x.properties."is a commercially available product") is TRUE
            then (asset_x.properties."product item master record") must NOT be NULL  
        errorMessage: "If the asset manufactured commercial product, then product item master information in required."
      #....
      - name: valid item master record in (.properties."product item master record")
        id: VJGKn1I9ex
        type: validation
        specification: |
          For (asset_x.properties."product item master record"), 
            only accept a master record whose value of (.properties."generic or specific product") is "commercially available product". 
        status: [specified, checked]
        $comment: related to 4y3dRfLcee
  
  #------------

  tool master record:
    oneOf: 
      - $ref: A-entity_record_schema/06_tool_master_schema.yml
      - type: NULL
    description: A association with a master record designates the asset as a stocked tool, which allows the tool to be checked into a storeroom and tracked as a part of an inventory. Without an association, the tool would be a unstocked. 
    sort order: 1-110
    TW_rule:
      #....
      - name: when to enable the tool master record
        id: NyQBbeL9xl
        specification: |
          if asset_x.properties."is a tool" = TRUE
            then enable (asset_x.properties."tool master record") property.      
        status: [specified, checked]
      #....
      - name: valid tool master record
        id: NyFFWlUcll
        specification: |
          For (asset_x.properties."tool master record"), 
            only accept a tool master record whose (.properties."generic or specific product") property value is "commercially available product"   
        status: [specified, checked]

  # Assignment Group of Properties
  #========================

  assignment type:
    oneOf: 
      - type: string
      - type: NULL
    description:
    enum:
      - to a role
      - to a user group
      - to a single user
      - not assigned
    TW_rule:
      #....
      - name: Rendering of (asset_x.properties."assignment type") data field.
        id: 4yARRuvOex
        type: UI
        description: |
          the options of this property should be presented as radial button
        status: specified
      #....
      - name: Valid Assignment of an Asset
        id: NyrzGKwuel
        type: [validation, assertion, UI]
        description: |
          If .properties."assignment type" = "to a role", then 
            - .properties."assigned to role" must NOT = NULL;
            - .properties."assigned to user" must = NULL
            - .properties."assigned to user group" must = NULL
          elif .properties."assignment type" = "to a user group", then
            - .properties."assigned to user group" must NOT = NULL;
            - .properties."assigned to role" must = NULL
            - .properties."assigned to user" must = NULL          
          elif .properties."assignment type" = "to a single user", then
            - .properties."assigned to user" must NOT = NULL;
            - .properties."assigned to role" must = NULL
            - .properties."assigned to user group" must = NULL
          elif .properties."assignment type" = NULL, then
            - .properties."assigned to role" must = NULL
            - .properties."assigned to user" must = NULL
            - .properties."assigned to user group" must = NULL
          Also, in the UI screen, disable the properties that should = NULL
        status: specified
    $comment: |
      This property is added to assist with the interpretation of the NULL value in the "assigned to role", "assigned to user group", or "assigned to user group" property. If the value here is "not assigned", then we know the asset is not assigned to anything. If the value here is NULL, we do not know whether this asset is assigned to anything. 
  
  #------------

  assigned to role:
    oneOf: 
      - $ref: A-entity_record_schema/02_role_schema.yml
      - type: NULL
    description: Role that the asset is designated to play. This value persists even if the asset is temporarily removed from the location of the role (for reasons such as repair).
        
  #------------

  assigned to user group:
    oneOf: 
      - $ref: A-entity_record_schema/04_org_schema.yml
      - type: NULL
    description: A group of people, such as a facility, work area, or crew to whom the asset is assigned for use. Indicates the assignment of an asset (usually a tool) that does not have a system role.

  #------------

  assigned to user:
    oneOf: 
      - $ref: A-entity_record_schema/02_role_schema.yml 
      - type: NULL
    description: Indicates the assignment of an asset (usually a tool) that does not have a system role.

  #========================

  maintenance group:
    oneOf: 
      - $ref: A-entity_record_schema/04_org_schema.yml 
      - type: NULL
    description: >
      Group responsible for the overall maintenance of the asset. For example, a unit, work area, or crew.
    $comment: The operational group is not explictly identified because it could be identified through its assignment. 
    TW_rule:
      #....
      - name: inheriting the asset's maintenace group value from its role
        id: VJ1QRgIclg
        description: |
          - if the value of (asset_x.properties."assigned to role") is role_y, then  
              inherit the value of (asset_x.properties."maintenance group") from (role_y.properties."maintenance group")
        status: [specified, checked]
 

  # Location Property Group
  #========================

  installation or storage location:
    oneOf: 
      - $ref: A-entity_record_schema/03_space_schema.yml
      - type: NULL

  #----------------

  service address or coordinate: 
    oneOf: 
      - $ref: MaximoServiceAddressObject
      - type: NULL
    $comment: |
      this is referencing Maximo's native service address object

  #------------------

  parent asset:
    oneOf: 
      - $ref: A-entity_record_schema/01_asset_schema.yml
      - type: NULL
    description: >
      The value in this property denotes the larger discrete asset or defined collection of assets, to which this asset is a part of.  NOTE: this property is not meant to be used for specifying the system hierarchy parent. That property is found on the role record, not the asset record. 
    $comment: |
      This field is commonly used when the asset is a part of a skid, structural tank, or switchgear cabinet, in which the asset parent in the system hierarchy should be the line entity. As such we will using this field to track that the asset is also a part of a phyical assembly. We would also be using this field to capture a serialized rotating component as a part of another discrete asset. This field can also be used to indicate an asset membership in a Defined Collection of Assets. 

  # Date Property Group
  #========================
  
  construction contract number:
    oneOf: 
      - type: string
      - type: NULL
    description: The construction contract number (usually RFQ#) assigned by the City

  first day of City operation:
    oneOf: 
      - type: string
      - type: NULL
    description: The day that the asset is turned over to the City from a contractor, or if the City installed the asset itself - the day the asset enters operation after testing is completed.
    $comment: |
      This usually coincides with "warranty start date".  However, if the asset is not delivered through a project, "warranty start date" may be empty. 

  warranty start date:
    oneOf: 
      - type: string
      - type: NULL

  warranty expiration date:
    oneOf: 
      - type: string, 
      - type: NULL

  #========================

  OEM serial:
    oneOf: 
      - type: string
      - type: NULL
    description: The serial number, affixed on the asset, designated by the manufacturer.
    $comment: |
      ASMP Discussion Log: The serial number is only populated when an asset experiences a movement (except for movement for removal), or when it is being check into a storeroom. Therefore, when the value of the OEM serial is NULL, it represents the fact that we do not know what the serial number is (and whether it has a serial number at all).
    
  #========================

  purchase cost (CAD):
    description: the original purchase cost of the asset (not necessary if the asset is associated with a item master record)
    oneOf: 
      - type: number
      - type: NULL

  #========================

  asset photo(s):
    oneOf: 
      - type: array # "array" indicates asset may have multiple photos
        items:
          allOf:
            - type: string # a photo's data is converted to a string, when represented in JSON.
            - oneOf:
              - contentMediaType: image/png
              - contentMediaType: image/jpg
      - type: NULL
  
  #========================

  duplicate record of:
    oneOf: 
      - type: array
        items:
          $ref: A-entity_record_schema/01_asset_schema.yml
      - type: NULL
  
  #========================

  record retirement information:
    $ref: "A-entity_record_schema/101_common_reusable_sub-schemas.yml#/definitions/record retirement sub-schema"

  
  # Background Properties Populated Automatically
  #==========================================================

  TW Asset Group:
    oneOf:
      - type: string
      - type: NULL
    invisible: true
    updated by system: true
    enum:
      - Drinking Water Network
      - Drinking Water Treatment Plants
      - Waste and Storm Water Network
      - Wastewater Treatment Plants
      - Independent Building
      - Multiple Major Systems
    $comment: |
      Note that this property is populated automatically, and not available for user to edit. Use-case: asset from the GIS will not be indexed on the hierarchy. The main use of this property is to provide a simple handle term, when one needs to summarize the collection of all assets imported from a certain layer(s) the GIS.
      
#############################################################
# HIGH LEVEL RULES
#############################################################

TW_rule:

#------ 

  - name: Asset must have a start of operation date info before we can indicate that it is operationally available.
    id: NyG2nzL5xg
    type: validation
    specification: |
      if both of the following properties are NULL
          - (asset_x.properties."first date of City operation")
          - (asset_x.properties."warranty start date")
        then the value of (asset_x.properties."operating state") CANNOT be "available (up)"

#--------

  - name: asset can be assigned exlcusively to either a role, user, or user group
    id: EkD-ZmIceg
    type: validation
    specification: | 
      only one of the following properties can have value (i.e., not NULL) at any given time. (It is also okay for all of them to be NULL) 
          - asset_x.properties."assigned to role"
          - asset_x.properties."assigned to user"
          - asset_x.properties."assigned to user group"
    errorMessage: "Between \"assigned to role\", \"assigned to user group\", \"installed\"assigned to user\", every asset may only have one type assignment."

#--------

  - name: consistency between (.properties."operating state") and assignment values
    id: 41OFxr8ceg
    type: [validation, assertion]
    specification: | 
      if an asset does not have a value in any of the following properties (i.e., all NULLs), 
          - asset_x.properties."assigned to role"
          - asset_x.properties."assigned to user"
          - asset_x.properties."assigned to user group"           
        then the value of (.properties."operating state") must be "not assigned work". The opposite must also be true.
    errorMessage: "An asset NOT assigned to a role, user, or user group should not be operating and therefore would not have an operating state"

#-------- 

  - name: consistency between asset's phyiscal status and its operating state and assignments
    id: NyG2nzL5xg
    type: [assertion, validation]
    specification: |
      If the value of (.properties."physical status") is NEITHER of the following
          - "installed"
          - "in possession"  
        then the following properties would take on the stated values
          .properties."operating state" = "not applicable"
          .properties."assigned to role" = NULL
          .properties."assigned to user" = NULL
          .properties."assigned to user group" = NULL
    errorMessage: "If an asset is not \"installed \\ in possession\" (see the physical status), then it should not have an operating state value or any assignment." 

#--------

  - name: an asset can only be assigned to a discrete asset role
    id: 4yBXuH8qle
    type: [validation]
    specification: |
      if (asset_x.properties."assigned to role") is NOT NULL
          then (asset_x.properties."assigned to role".properties."role class".properties."discrete asset role") = TRUE
    errorMessage: an asset can only be assigned to a discrete asset role

#--------

  - name: inheriting the asset location information from its role
    id: NJdGTHLqeg
    type: [assertion]
    specification: |
        if 
          all of the following are true:
            - .properties."operating state" = "installed"
            - .properties."assigned to role" is NOT NULL
          and one of the following is true
            - .properties."assigned to role".properties."asset installation location" is NOT NULL
            - .properties."assigned to role".properties."service address or coordinate" is NOT NULL
        then
            (.properties."installation or storage location") would be set to the value of 
              (.properties."assigned to role".properties."asset installation location")
            (.properties."service address or coordinate") would be set to the value of 
              (.properties."assigned to role".properties."service address or coordinate")
      


OPEN AND TODO ITEMS: |
  []  - add RULE: asset can be assigned to an asset collection and a group or a person at the same time (though it cannot be assigned to a discrete asset role and a group at the same time)

  [] - Need to have a different set of data entry (i.e. what is NULLable) requirement for Linear assets
  
  [] (April 26 Review) the ability to assigned to a vehicle is missing - it should be considered as a satellite storeroom
        ANS: May 6th: TH: I am covering this with the existing property "installation or storage location"




  
  

